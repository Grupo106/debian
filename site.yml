- hosts: all
  become: yes
  vars:
    - postgresql_version: 9.4 # version de postgres a utilizar
    - postgresql_user: morfeo
    - postgresql_passwd: grupo106@unlam
    - src_path: /usr/local/src # directorio donde se guardara el codigo fuente

  # Tasks
  # =========================================================================
  
  # utilidades
  # -------------------------------------------------------------------------
  tasks:
  - name: Instalar screen
    apt: name={{ item }}
    with_items:
      - screen
      - bridge-utils
      - git
      - make
      - gcc
      - locales
  
  # postgresql
  # -------------------------------------------------------------------------
  - name: Crear locales
    locale_gen: name=es_AR.UTF-8 state=present

  - name: Instalar PostgreSQL {{ postgresql_version }}
    apt: name=postgresql-{{ postgresql_version }}
    notify: crear cluster

  - name: Habilitar servicio postgresql
    service: name=postgresql enabled=yes state=started

  - name: Copiar schema
    template: src=templates/schema.sql.j2 dest=/tmp/schema.sql

  - name: Crear schema
    command: psql -f /tmp/schema.sql
    become_user: postgres

  - name: Instalar git
    apt: name=git

  # adquisidor
  # -------------------------------------------------------------------------
  - name: Instalar dependencias adquisidor
    apt: name={{ item }}
    with_items:
      - libecpg-dev
      - libpcap0.8-dev
  
  - name: Descargar ultima version del adquisidor
    git: repo=https://github.com/Grupo106/adquisidor.git
         dest={{ src_path }}/adquisidor
         version=master
    notify:
      - Compilar adquisidor
      - Instalar adquisidor

  # configuracion de red
  # -------------------------------------------------------------------------
  - name: Configurar interfaces de red
    template:
      src: templates/etc/network/interfaces
      dest: /etc/network/interfaces
    notify:
      - reboot

  # Handlers
  # =========================================================================
  handlers:
  - name: crear cluster
    command: pg_createcluster {{ postgresql_version }} main --start

  - name: reboot
    command: shutdown -r now "Ansible updates triggered"
    async: 0
    poll: 0
    ignore_errors: true

  - name: Compilar adquisidor
    command: make {{ item }} chdir={{ src_path }}/adquisidor
    with_items:
      - clean
      - all

  - name: Instalar adquisidor
    command: make install chdir={{ src_path }}/adquisidor
